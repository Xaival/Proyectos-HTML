<!DOCTYPE html>
<html lang="es" >
<head>
<meta charset="UTF-8">
<title>Embellecedor código SVG</title>
<style>
	* {margin:0; padding:0; box-sizing:border-box;}
	body{
		background-color: #101010;

		display: flex;
		flex-wrap: wrap;
		justify-content:space-evenly;
		overflow-y: hidden;

		color: white;
		font-family: Roboto;
		font-size: min(18px, max(5vw, 13px));
	}
	body > *{
		width:33%;
		height:100vh;

		resize: none;
		padding: 8px;
		padding-top: 20px;
		font-size:min(14px, max(5vw, 13px));
	}
	#SalidaTexto{overflow-x: hidden; overflow-y: auto;}

	@media screen and (max-width: 750px) {
		body > *{width:100vw; height:33vh;}
		#SalidaPreview{display: none;}
		#SalidaTexto{overflow-y: visible;}
	}

	/* Texto de entrada */
	textarea{
		background-color: #101010;
		color: white;
		border-width: 0px;
		outline:0;
	}

	/* Formulario */
	#form {
		background-color: #1f1f1f;
		display: flex;
		flex-direction: column;
		line-height: 15px;
	}
	h2 {text-align:center; line-height: 20px;}
	input {
		margin-top: 5px;
		border-width: 0px;
		outline:0;
	}
	input[type="checkbox"]{margin-right: 5px;}
	input[type="text"]{height:1.5em;}
	select,
	.boton{height: 1.8em;}
	
	.boton{
		background-color: #FFF;
		padding: 2px 0;
		
		color:black;
		cursor: pointer;
		text-align: center;
		
		border-radius: 3px;
		border: 2px outset;
		border-color: -internal-light-dark(rgb(118, 118, 118), rgb(133, 133, 133));
	}
	.boton:hover{background-color: #e6e6e6;}
	.boton:active{background-color: #f2f2f2;}
	

	#SalidaPreview{width: 100%;min-height: 200px;max-height: 50vh;}
	#SalidaPreview svg{background-color: #191919;fill: #FFF;width: 100%;height: 100%;}
</style>
</head>
<body>
	<! –– Texto de entrada ––>
	<textarea id="EntradaTexto" placeholder="Introduce el texto aquí..." onkeyup="CambiosSalida()"></textarea>

	<! –– Formulario ––>
	<div id="form">
		<h2>Embellecedor código SVG</h2>
		<br>
		<select id="HTML_CSS" onchange="Compatibilizar('A'); CambiosSalida()">
			<option>En HTML</option>
			<option>En CSS</option>
		</select>
		<br>
		<select id="Espacios" onchange="Compatibilizar('B'); CambiosSalida()">
			<optgroup label="Defecto">
				<option>Por defecto</option>
				<option>Mantener solo espacios</option>
				<option>Mantener solo saltos de línea</option>
			</optgroup>
			<optgroup label="Formateado">
				<option>Sin espacios</option>
				<option>Saltos de línea</option>
			</optgroup>
		</select>
		<br>
		<label><input type="checkbox" id="Beautifier" onchange="CambiosSalida()" checked>Quitar atributos</label>
		<br>
		<div class="boton" onclick="Abrir()">Abrir archivo</div>
		<br>
		<div id="SalidaPreview"></div>
	</div>

	<! –– Respuesta ––>
	<textarea readonly id="SalidaTexto" onclick="CopiarClipboard()"></textarea>
<script>
	async function Abrir(){
		let [fileHandle] = await window.showOpenFilePicker({
			excludeAcceptAllOption: true,
			startIn: 'downloads',
			multiple: false,
			types:[{
				description: 'Images (*.svg)',
				accept:{'image/svg':['.svg']}
			}]
		});
		let fileData = await fileHandle.getFile();
		EntradaTexto.innerText = await fileData.text();
	}

	function Compatibilizar(Cambiar) {
		HTML_CSS = document.getElementById("HTML_CSS"),
		Espacios = document.getElementById("Espacios");
		
		if(Cambiar=="A" && HTML_CSS.value=="En CSS"){
			Espacios.value="Sin espacios";
		} else if(Cambiar=="B" && Espacios.value!="Sin espacios") {
			HTML_CSS.value="En HTML";
		}
	}


	function CambiosSalida() {
		let EntradaTexto = document.getElementById("EntradaTexto").value,
			SalidaTexto = document.getElementById("SalidaTexto"),

			HTML_CSS = document.getElementById("HTML_CSS").value,
			Espacios = document.getElementById("Espacios").value,
			Beautifier = document.getElementById("Beautifier").checked;

		// Vaciar
		SalidaTexto.innerHTML = "";

		// Conversión Texto defecto base
		EntradaTexto = EntradaTexto.replaceAll("  "," ").replaceAll("%3C","<").replaceAll("%3E",">").replaceAll(" >",">").replaceAll("%23","#").replaceAll("'",'"');

		// Extraer codigo solo del SVG
		let ComienzoSVG = EntradaTexto.indexOf("<svg"),
			FinSVG = EntradaTexto.indexOf("</svg>")+6;
			EntradaTexto = EntradaTexto.substr(ComienzoSVG, FinSVG-ComienzoSVG);

		
		// Espacios y saltos de linea
		switch (true) {
			// Sin espacios o es para convertirse en CSS
			case Espacios == "Sin espacios" || HTML_CSS=="En CSS":
				EntradaTexto = EntradaTexto.replaceAll("\t","").replaceAll(" <","<").replace(/ +/g," ").replaceAll(" >",">").replaceAll(" />","/>").replaceAll("<g></g>","").replaceAll("\n","");
			break;
			// Salto de linea reformateado
			case Espacios == "Saltos de línea":
				EntradaTexto = EntradaTexto.replace(/\n+/g,"").replaceAll(">",">\n");
			break;
			// Mantener solo espacios
			case Espacios == "Mantener solo espacios":
				EntradaTexto = EntradaTexto.replaceAll("\n","");
			break;
			// Quitar espacios y dejar saltos de linea
			case Espacios == "Mantener solo saltos de línea":
				EntradaTexto = EntradaTexto.replaceAll("\t","").replaceAll(" <","<").replace(/ +/g," ").replaceAll(" >",">").replaceAll(" />","/>").replaceAll("<g></g>","");
			break;
		}


		// Embellecer
		if(Beautifier){
			// Eliminar atributos
			let ArrayElimnarAtributos = [" class=", " onclick=",  " clip-rule=", " data-name=", " enable-background=", " fill-rule=", " focusable=", " id=", " inkscape:export-filename=", " inkscape:export-xdpi=", " inkscape:export-ydpi=", " inkscape:output_extension=", " inkscape:version=", " sodipodi:docname=", " stroke-linejoin=", " stroke-miterlimit=", " style=", " version=", " xml:space=", " xmlns:", " xmlns:cc=", " xmlns:dc=", " xmlns:inkscape=", " xmlns:ns1=", " xmlns:rdf=", " xmlns:sodipodi=", " xmlns:svg=", " xmlns:xlink=", " xmlns="];
			for (let i = 0; i<ArrayElimnarAtributos.length; i++) {
				let ComienzoElimnar = EntradaTexto.indexOf(ArrayElimnarAtributos[i]),
					FinElimnar = EntradaTexto.indexOf('"',EntradaTexto.indexOf('"',ComienzoElimnar)+1)+1,
					TextoEliminar = EntradaTexto.substr(ComienzoElimnar, FinElimnar-ComienzoElimnar);

				if(ComienzoElimnar>0){EntradaTexto = EntradaTexto.replaceAll(TextoEliminar,""); i--}
			}
			
			// Eliminar atributos de svg
			let ArrayElimnarAtributosSVG = [" height=", " width=",  " x=", " y="];
			for (let i = 0; i<ArrayElimnarAtributosSVG.length; i++) {
				let ComienzoElimnar = EntradaTexto.indexOf(ArrayElimnarAtributosSVG[i]),
					FinElimnar = EntradaTexto.indexOf('"',EntradaTexto.indexOf('"',ComienzoElimnar)+1)+1,
					TextoEliminar = EntradaTexto.substr(ComienzoElimnar, FinElimnar-ComienzoElimnar);

				if(ComienzoElimnar>0 && FinElimnar<=EntradaTexto.indexOf(">")){EntradaTexto = EntradaTexto.replace(TextoEliminar,""); i--}
			}
			
			// Eliminar metadatos
			let ArrayElimnarMetadatosEntrada = ["<metadata"],
				ArrayElimnarMetadatosSalida = ["</metadata>"];
			for (let i = 0; i<ArrayElimnarMetadatosEntrada.length; i++) {
				let ComienzoElimnar = EntradaTexto.indexOf(ArrayElimnarMetadatosEntrada[i]),
					FinElimnar = EntradaTexto.indexOf(ArrayElimnarMetadatosSalida[i],ComienzoElimnar)+ArrayElimnarMetadatosSalida[i].length,
					TextoEliminar = EntradaTexto.substr(ComienzoElimnar, FinElimnar-ComienzoElimnar);

				if(ComienzoElimnar>0){EntradaTexto = EntradaTexto.replaceAll(TextoEliminar,""); i--}
			}
		}
		
		//Añadir preview
		document.getElementById("SalidaPreview").innerHTML = EntradaTexto;

		// Conversión Texto
		if(HTML_CSS=="En CSS"){
			if(!(EntradaTexto.includes('xmlns="http://www.w3.org/2000/svg"'))){
				EntradaTexto = EntradaTexto.replaceAll('<svg','<svg xmlns="http://www.w3.org/2000/svg"')
			}
			EntradaTexto = 'url("data:image/svg+xml,'+EntradaTexto.replaceAll("  "," ").replaceAll("<","%3C").replaceAll(">","%3E").replaceAll("#","%23").replaceAll('"',"'").replaceAll("\n","").replaceAll("\t","")+'")';
		}

		//Añadir linea
		SalidaTexto.innerHTML += EntradaTexto;
	}



	function CopiarClipboard() {
		let SalidaTexto = document.getElementById("SalidaTexto");
		SalidaTexto.select();
		SalidaTexto.setSelectionRange(0, 99999);
		navigator.clipboard.writeText(SalidaTexto.value);
	}
</script>
</body>
</html>
